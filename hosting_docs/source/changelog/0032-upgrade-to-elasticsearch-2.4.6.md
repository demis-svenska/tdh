<!--THIS FILE IS AUTOGENERATED: DO NOT EDIT-->
<!--See https://github.com/dimagi/commcare-cloud/blob/master/changelog/README.md for instructions-->
# 32. ES upgrade from 1.7.6 to 2.4.6

**Date:** 2020-02-05

**Optional per env:** _required on all environments_


## CommCare Version Dependency
The following version of CommCare must be deployed before rolling out this change:
[064bb6df](https://github.com/dimagi/commcare-hq/commit/064bb6dfc2b333cc8e6e3955b0c5d30513c5f4be)


## Change Context
This change upgrade Elasticsearch from 1.7.6 to 2.4.6 version.
CommCare HQ releases after April 2, 2020 will not continue to support Elasticsearch 1.7.6,
so we strongly recommend applying this change before then.

## Details
As part of our ongoing effort to keep CommCare HQ up to date with the latest tools and
libraries we have updated Elasticsearch from 1.7.6 to 2.4.6 version.

## Steps to update

Before you start, make sure that your disk usage is well below 50%,
or that you have a place to back up to on another disk or remotely.

0. For commands including `${ENV}` and ${ES_HOST} below to work, make sure to set `ENV` to the name of your environment, and `ES_HOST` to the IP address of one of your ES nodes:
```
ENV=${ENV}
ES_HOST=$(commcare-cloud ${ENV} lookup elasticsearch:0)
```

1. Stop the site
```bash
commcare-cloud ${ENV} downtime start
```

2. Add the following parameters to your environment's `public.yml`:
```
elasticsearch_version: 2.4.6
elasticsearch_download_sha256: 5f7e4bb792917bb7ffc2a5f612dfec87416d54563f795d6a70637befef4cfc6f.
...
localsettings:
  ...
  ELASTICSEARCH_MAJOR_VERSION: 2
```

3. Update the local settings
```bash
commcare-cloud ${ENV} update-config
```

4. Disable Elasticsearch shard allocation
```bash
curl -X PUT "${ES_HOST}:9200/_cluster/settings?pretty" -H 'Content-Type: application/json' -d'
{
  "persistent": {
    "cluster.routing.allocation.enable": "none"
  }
}
'
```

5. Perform a synced flush
```bash
curl -X POST "${ES_HOST}:9200/_flush/synced?pretty"  # safe to reissue a few times if it fails
```

6. Stop the Monit and Elasticsearch services
```bash
commcare-cloud ${ENV} run-shell-command all "service monit stop" -b --limit=elasticsearch
commcare-cloud ${ENV} run-shell-command all "service elasticsearch stop" -b --limit=elasticsearch
```

7. Make a backup of the 1.7.6 data directory. The following is one way that you can do that:
```bash
commcare-cloud ${ENV} run-shell-command all "cp -r /opt/data/elasticsearch-1.7.6 /opt/data/elasticsearch-1.7.6-backup" -b --limit=elasticsearch
```

8. Install and run the new version of Elasticsearch
```bash
commcare-cloud ${ENV} ansible-playbook deploy_stack.yml --limit=elasticsearch --tags=elasticsearch
```

9. Stop the Monit and Elasticsearch services
```bash
commcare-cloud ${ENV} run-shell-command all "service monit stop" -b --limit=elasticsearch
commcare-cloud ${ENV} run-shell-command all "service elasticsearch stop" -b --limit=elasticsearch
```

10. Rename the newly created 2.4.6 data directory so it's out of the way and then move the 1.7.6 data directory to the new 2.4.6 data directory location
```bash
commcare-cloud ${ENV} run-shell-command all "mv /opt/data/elasticsearch-2.4.6 /opt/data/elasticsearch-2.4.6-new-installation" -b --limit=elasticsearch
commcare-cloud ${ENV} run-shell-command all "mv /opt/data/elasticsearch-1.7.6 /opt/data/elasticsearch-2.4.6" -b --limit=elasticsearch
```
11. Verify the permissions and size of the data directory
```bash
commcare-cloud ${ENV} run-shell-command all "du -ch /opt/data/elasticsearch-2.4.6" -b --limit=elasticsearch
```

12. Start the Monit and Elasticsearch services
```bash
commcare-cloud ${ENV} run-shell-command all "service monit start" -b --limit=elasticsearch
commcare-cloud ${ENV} run-shell-command all "service elasticsearch start" -b --limit=elasticsearch
```

13. Verify that the cluster status is yellow
```bash
curl -XGET "${ES_HOST}:9200/_cluster/health?pretty"
```

14. Enable the cluster routing
```bash
curl -X PUT "${ES_HOST}:9200/_cluster/settings?pretty" -H 'Content-Type: application/json' -d'
{
  "persistent": {
     "cluster.routing.allocation.enable": "all"
  }
}
'
```

15. Start the site
```bash
commcare-cloud ${ENV} downtime end
```
